function shuffleArray(a){for(var b=a.length-1;b>0;b--){var c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c],a[c]=d}return a}function guessProgress(){var a=manager.getAskedQuestions(),b=manager.getScore(),c=b/a;return c}function loadNext(){var a=manager.getNext();if(null===a)player.pause(function(){textToVoice.say("The game has finished! Your score is "+manager.getScore()+" points.")});else{renderer.render(a);var b=a;player.pause(function(){reader.read(a,function(){player.play(b)})})}}function login(){var a=new SpotifyPlaylistsImporter;a.login(function(b){a.importPlaylists(b,function(a){init(a)})})}function init(a){generator=new QuestionsGenerator(a),generator.load();generator.generateQuestions(function(a){manager=new QuestionsManager(a),renderer=new QuestionRenderer,textToVoice=new TextToVoice,reader=new QuestionReader(textToVoice),player=new Player,document.getElementById("logged-in").style.display="block",document.getElementById("logged-out").style.display="none",manager.onUserResponse=function(a,b,c){var d="",e=guessProgress(),f=manager.getAskedQuestions();player.goToVolume(.1,function(){if(a){e>.7&&f>0&&f%5===0&&(d="Oh dude, you know your stuff!");var g=["Great!","Well done!","Awesome!","That's it! {0}.","Right answer!","You're right!","Yes, it's {0}!","Of course it is {0}."],h=g[Math.random()*g.length|0];h=h.replace("{0}",b),textToVoice.say(h+" "+d,loadNext)}else{.2>=e&&f>0&&f%5===0?d+="Did you create your own playlists? It seems you don't have a clue about your music":.7>=e&&f>0&&f%5===0&&(d="You are not doing very well. Keep improving!");var g=["Almost! It was {1}.","{0}? Wrong answer! It is {1}.","How can it be {0}? You're wrong! It's definitely {1}.","That's wrong! It's {1}."],h=g[Math.random()*g.length|0];h=h.replace("{0}",c),h=h.replace("{1}",b),textToVoice.say(h+" "+d,loadNext)}})},loadNext()})}!function(a){if("function"==typeof bootstrap)bootstrap("when",a);else if("object"==typeof exports)module.exports=a();else if("function"==typeof define&&define.amd)define(a);else if("undefined"!=typeof ses){if(!ses.ok())return;ses.makeWhen=a}else"undefined"!=typeof window?window.when=a():global.when=a()}(function(){var a;return function(a,b,c){function d(c,f){if(!b[c]){if(!a[c]){var g="function"==typeof require&&require;if(!f&&g)return g(c,!0);if(e)return e(c,!0);throw new Error("Cannot find module '"+c+"'")}var h=b[c]={exports:{}};a[c][0].call(h.exports,function(b){var e=a[c][1][b];return d(e?e:b)},h,h.exports)}return b[c].exports}for(var e="function"==typeof require&&require,f=0;f<c.length;f++)d(c[f]);return d}({1:[function(a,b){var c=b.exports={};c.nextTick=function(){var a="undefined"!=typeof window&&window.setImmediate,b="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(a)return function(a){return window.setImmediate(a)};if(b){var c=[];return window.addEventListener("message",function(a){if(a.source===window&&"process-tick"===a.data&&(a.stopPropagation(),c.length>0)){var b=c.shift();b()}},!0),function(a){c.push(a),window.postMessage("process-tick","*")}}return function(a){setTimeout(a,0)}}(),c.title="browser",c.browser=!0,c.env={},c.argv=[],c.binding=function(){throw new Error("process.binding is not supported")},c.cwd=function(){return"/"},c.chdir=function(){throw new Error("process.chdir is not supported")}},{}],2:[function(b,c){!function(b){!function(a,c){"use strict";a(function(){function a(a,b,c,d){return e(a).then(b,c,d)}function d(a,b){this.then=a,this.inspect=b}function e(a){return h(function(b){b(a)})}function f(b){return a(b,l)}function g(){function a(a,f,g){b.resolve=b.resolver.resolve=function(b){return d?e(b):(d=!0,a(b),c)},b.reject=b.resolver.reject=function(a){return d?e(l(a)):(d=!0,f(a),c)},b.notify=b.resolver.notify=function(a){return g(a),a}}var b,c,d;return b={promise:N,resolve:N,reject:N,notify:N,resolver:{resolve:N,reject:N,notify:N}},b.promise=c=h(a),b}function h(a){return i(a,M.PromiseStatus&&M.PromiseStatus())}function i(a,b){function c(a,c,d){var e=i(function(b,e,f){function g(g){g.then(a,c,d).then(b,e,f)}p?p.push(g):A(function(){g(o)})},b&&b.observed());return e}function e(){return o?o.inspect():z()}function f(a){p&&(o=j(a),n(p,o),p=N,b&&o.then(function(){b.fulfilled()},function(a){b.rejected(a)}))}function g(a){f(l(a))}function h(a){p&&n(p,m(a))}var k,o,p=[];k=new d(c,e);try{a(f,g,h)}catch(q){g(q)}return k}function j(a){return a instanceof d?a:a===Object(a)&&"then"in a?h(function(b,c,d){A(function(){try{var e=a.then;"function"==typeof e?F(e,a,b,c,d):b(k(a))}catch(f){c(f)}})}):k(a)}function k(a){var b=new d(function(c){try{return"function"==typeof c?j(c(a)):b}catch(d){return l(d)}},function(){return x(a)});return b}function l(a){var b=new d(function(c,d){try{return"function"==typeof d?j(d(a)):b}catch(e){return l(e)}},function(){return y(a)});return b}function m(a){var b=new d(function(c,d,e){try{return"function"==typeof e?m(e(a)):b}catch(f){return m(f)}});return b}function n(a,b){A(function(){for(var c,d=0;c=a[d++];)c(b)})}function o(a){return a&&"function"==typeof a.then}function p(b,c,d,e,f){return a(b,function(b){function g(d,e,f){function g(a){n(a)}function h(a){m(a)}var i,j,k,l,m,n,o,p;if(o=b.length>>>0,i=Math.max(0,Math.min(c,o)),k=[],j=o-i+1,l=[],i)for(n=function(a){l.push(a),--j||(m=n=C,e(l))},m=function(a){k.push(a),--i||(m=n=C,d(k))},p=0;o>p;++p)p in b&&a(b[p],h,g,f);else d(k)}return h(g).then(d,e,f)})}function q(a,b,c,d){function e(a){return b?b(a[0]):a[0]}return p(a,1,e,c,d)}function r(a,b,c,d){return v(a,C).then(b,c,d)}function s(){return v(arguments,C)}function t(a){return v(a,x,y)}function u(a,b){return v(a,b)}function v(b,c,d){return a(b,function(b){function e(e,f,g){function h(b,h){a(b,c,d).then(function(a){i[h]=a,--k||e(i)},f,g)}var i,j,k,l;if(k=j=b.length>>>0,i=[],!k)return void e(i);for(l=0;j>l;l++)l in b?h(b[l],l):--k}return h(e)})}function w(b,c){var d=F(E,arguments,1);return a(b,function(b){var e;return e=b.length,d[0]=function(b,d,f){return a(b,function(b){return a(d,function(a){return c(b,a,f,e)})})},D.apply(b,d)})}function x(a){return{state:"fulfilled",value:a}}function y(a){return{state:"rejected",reason:a}}function z(){return{state:"pending"}}function A(a){1===H.push(a)&&G(B)}function B(){for(var a,b=0;a=H[b++];)a();H=[]}function C(a){return a}a.promise=h,a.resolve=e,a.reject=f,a.defer=g,a.join=s,a.all=r,a.map=u,a.reduce=w,a.settle=t,a.any=q,a.some=p,a.isPromise=o,d.prototype={otherwise:function(a){return this.then(N,a)},ensure:function(a){function b(){return e(a())}return this.then(b,b)["yield"](this)},"yield":function(a){return this.then(function(){return a})},spread:function(a){return this.then(function(b){return r(b,function(b){return a.apply(N,b)})})},always:function(a,b){return this.then(a,a,b)}};var D,E,F,G,H,I,J,K,L,M,N;return H=[],M="undefined"!=typeof console?console:a,I=c.setTimeout,G="function"==typeof setImmediate?setImmediate.bind(c):"object"==typeof b&&b.nextTick?b.nextTick:"object"==typeof vertx?vertx.runOnLoop:function(a){I(a,0)},J=Function.prototype,K=J.call,F=J.bind?K.bind(K):function(a,b){return a.apply(b,E.call(arguments,2))},L=[],E=L.slice,D=L.reduce||function(a){var b,c,d,e,f;if(f=0,b=Object(this),e=b.length>>>0,c=arguments,c.length<=1)for(;;){if(f in b){d=b[f++];break}if(++f>=e)throw new TypeError}else d=c[1];for(;e>f;++f)f in b&&(d=a(d,b[f],f,b));return d},a})}("function"==typeof a&&a.amd?a:function(a){c.exports=a()},this)}(b("__browserify_process"))},{__browserify_process:1}]},{},[2])(2)});var Player=function(){this._audioObject=null};Player.prototype.play=function(a){switch(console.log("Playing",a),a.type){case"guess_album_year":var b=new XMLHttpRequest;b.open("GET","https://api.spotify.com/v1/albums/"+a.spotify_id,!0);var c=this;b.onreadystatechange=function(){if(4==b.readyState&&200==b.status){var a=JSON.parse(b.responseText);c.pause(function(){c._audioObject=new Audio(a.tracks[0].preview_url),c._audioObject.volume=0,c._audioObject.play(),c.goToVolume(.5)})}},b.send(null);break;case"guess_track_name":case"guess_track_artist":var b=new XMLHttpRequest;b.open("GET","https://api.spotify.com/v1/tracks/"+a.spotify_id,!0);var c=this;b.onreadystatechange=function(){if(4==b.readyState&&200==b.status){var a=JSON.parse(b.responseText);c.pause(function(){c._audioObject=new Audio(a.preview_url),c._audioObject.volume=0,c._audioObject.play(),c.goToVolume(.5)})}},b.send(null)}},Player.prototype.pause=function(a){this.goToVolume(0,a)},Player.prototype.goToVolume=function(a,b){var c=this;if(null!==this._audioObject)var d=setInterval(function(){c._audioObject.volume=c._audioObject.volume>a?Math.max(c._audioObject.volume-.1,a):Math.min(c._audioObject.volume+.1,a),c._audioObject.volume===a&&(clearInterval(d),b&&b())},100);else b()};var TextToVoice=function(){};TextToVoice.prototype.say=function(a,b){var c=speechSynthesis.getVoices(),d=new SpeechSynthesisUtterance;d.lang="en-UK",d.voice=c[1],d.text=a,console.log(d),speechSynthesis.speak(d),console.log("Saying "+a),b&&(d.onend=function(){console.log("Machine finished speaking"),b(),d.onend=null,speechSynthesis.cancel()})};var QuestionsGeneratorHelper={getAlbum:function(a,b){console.log("Getting album",a);var c=new XMLHttpRequest;c.open("GET","https://api.spotify.com/v1/albums/"+a,!0);c.onreadystatechange=function(){if(4==c.readyState&&200==c.status){var a=JSON.parse(c.responseText);b(a)}},c.send(null)}},QuestionsGenerator=function(a){this.playlists=a,this._tracks=[]};QuestionsGenerator.prototype.load=function(){var a=this;this._tracks=[],this.playlists.forEach(function(b){null!==b&&(a._tracks=a._tracks.concat(b.items.map(function(a){return a.track})))}),this._artists={},this._tracks.forEach(function(b){b.artists.forEach(function(b){b.name in a._artists||(a._artists[b.name]=1)})}),this._artistsArray=Object.keys(this._artists)},QuestionsGenerator.prototype.getTracks=function(){return this._tracks},QuestionsGenerator.prototype.getArtists=function(){return this._artistsArray},QuestionsGenerator.prototype.generateQuestions=function(a){for(var b=["guess_track_artist","guess_track_name","guess_album_year"],c=10,d=[],e=this,f=0,g=0;c>g;g++){var h=b[Math.random()*b.length|0],i=this._tracks[Math.random()*this._tracks.length|0];switch(h){case"guess_track_artist":var j=new GuessTrackArtistQuestion(i.id,i.artists[0].name);d.push(j);break;case"guess_album_year":f++;var j=new GuessAlbumYearQuestion(i.id,i.album.id);d.push(j),j.fetchAlbumInfo(function(){f--,0===f&&a(e._cleanAndRandomize(d))});break;case"guess_track_name":f++;var j=new GuessTrackNameQuestion(i.name,i.id,i.album.id);d.push(j),j.fetchCover(function(){f--,0===f&&a(e._cleanAndRandomize(d))})}}0===f&&a(this._cleanAndRandomize(d))},QuestionsGenerator.prototype._cleanAndRandomize=function(a){function b(a){for(var b=a.length-1;b>0;b--){var c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c],a[c]=d}return a}var c=b(a);return c.map(function(a){return a.getJSON()})};var GuessTrackNameQuestion=function(a,b,c){this.trackName=a,this.trackId=b,this.albumId=c,this.others=this._getRandomTrackName(a,2),this.cover=null};GuessTrackNameQuestion.prototype._getRandomTrackName=function(a,b){for(var c=[];c.length<b;){var d=generator.getTracks()[Math.random()*generator.getTracks().length|0].name;d!=a&&-1===c.indexOf(d)&&c.push(d)}return c},GuessTrackNameQuestion.prototype.fetchCover=function(a){var b=this;QuestionsGeneratorHelper.getAlbum(this.albumId,function(c){b.cover=c.images.LARGE.image_url,a()})},GuessTrackNameQuestion.prototype.getJSON=function(){return{type:"guess_track_name",name:this.trackName,spotify_id:this.trackId,others:this.others,cover:this.cover,answer:this.trackName}};var GuessAlbumYearQuestion=function(a,b){this.trackId=a,this.albumId=b,this.others=null,this.year=null,this.cover=null};GuessAlbumYearQuestion.prototype._getRandomYears=function(a,b){for(var c=[];c.length<b;){var d=5,e=a-d+(Math.random()*d*2|0);e!=a&&-1===c.indexOf(e)&&e<=(new Date).getFullYear()&&c.push(e)}return c},GuessAlbumYearQuestion.prototype.fetchAlbumInfo=function(a){var b=this;QuestionsGeneratorHelper.getAlbum(this.albumId,function(c){b.albumId=c.id,b.year=c.release_year,b.others=b._getRandomYears(c.release_year,2),b.cover=c.images.LARGE.image_url,a()})},GuessAlbumYearQuestion.prototype.getJSON=function(){return{type:"guess_album_year",spotify_id:this.albumId,others:this.others,cover:this.cover,year:this.year,answer:this.year}};var GuessTrackArtistQuestion=function(a,b){this.trackId=a,this.artistName=b};GuessTrackArtistQuestion.prototype.getJSON=function(){return{type:"guess_track_artist",spotify_id:this.trackId,others:this.others,name:this.artistName,answer:this.artistName,others:this._getRandomArtist(this.artistName,2)}},GuessTrackArtistQuestion.prototype._getRandomArtist=function(a,b){for(var c=[];c.length<b;){var d=generator.getArtists()[Math.random()*generator.getArtists().length|0];d!=a&&-1===c.indexOf(d)&&c.push(d)}return c};var QuestionsManager=function(a){this.questions=a,this.currentQuestion=-1,this.score=0};QuestionsManager.prototype.getScore=function(){return this.score},QuestionsManager.prototype.getAskedQuestions=function(){return this.currentQuestion+1},QuestionsManager.prototype.getNext=function(){if(this.currentQuestion++,this.currentQuestion<this.questions.length){var a=this.questions[this.currentQuestion];switch(a.score=this.score,a.progress=100*(this.getAskedQuestions()-1)/this.questions.length,a.type){case"guess_album_year":a.options=shuffleArray([a.year].concat(a.others));break;case"guess_track_artist":case"guess_track_name":a.options=shuffleArray([a.name].concat(a.others))}return console.log("Next question is",a),a}return null},QuestionsManager.prototype.check=function(a){var b=this.questions[this.currentQuestion];b.options[a]===b.answer?(this.score++,this.onUserResponse&&this.onUserResponse(!0,b.answer)):this.onUserResponse&&this.onUserResponse(!1,b.answer,b.options[a])},QuestionsManager.prototype.onUserResponse=null;var QuestionReader=function(a){this._textToVoice=a};QuestionReader.prototype.read=function(a,b){switch(a.type){case"guess_album_year":var c=["When was this album released?","What's the release year of this album?","I'm sure you know the year of this album","Try to remember when this album was released.","This album was released in what year?"],d=c[Math.random()*c.length|0];this._textToVoice.say(d,function(){b()});break;case"guess_track_artist":var c=["Who is the singer of this song?","Who performs this song?","Who is the artist?","What's the artist of this masterpiece?"],d=c[Math.random()*c.length|0];this._textToVoice.say(d,function(){b()});break;case"guess_track_name":var c=["What's the name of this song?","Can you guess the name of this song?","I'm sure you know the name of this song","You know the name of this song! Don't you?"],d=c[Math.random()*c.length|0];this._textToVoice.say(d,function(){b()})}};var QuestionRenderer=function(){this._templates={},this._templates.guess_name=Handlebars.compile(document.getElementById("template-guess-name").innerHTML),this._templates.album=Handlebars.compile(document.getElementById("template-album").innerHTML)};QuestionRenderer.prototype.render=function(a){var b=this,c=document.getElementById("question");switch(a.type){case"guess_album_year":var d=new XMLHttpRequest;d.open("GET","https://api.spotify.com/v1/albums/"+a.spotify_id,!0);var b=this;d.onreadystatechange=function(){if(4==d.readyState&&200==d.status){var e=JSON.parse(d.responseText);c.classList.add("fadeout"),setTimeout(function(){c.innerHTML=b._templates.album({question:"Guess the year of the album!",options:a.options,cover:e.images.LARGE.image_url,score:a.score,progress:a.progress});for(var d=c.querySelectorAll(".button-response"),f=0;f<d.length;f++)d[f].addEventListener("click",function(a){a.preventDefault(),manager.check(+this.getAttribute("data-index"))},!1);c.classList.remove("fadeout")},500)}},d.send(null);break;case"guess_track_name":c.classList.add("fadeout"),setTimeout(function(){c.innerHTML=b._templates.guess_name({question:"Guess the name of the song!",options:a.options,score:a.score,cover:a.cover,progress:a.progress});for(var d=c.querySelectorAll(".button-response"),e=0;e<d.length;e++)d[e].addEventListener("click",function(a){a.preventDefault(),manager.check(+this.getAttribute("data-index"))},!1);c.classList.remove("fadeout")},500);break;case"guess_track_artist":c.classList.add("fadeout"),setTimeout(function(){c.innerHTML=b._templates.guess_name({question:"Guess the name of the artist!",options:a.options,score:a.score,cover:"img/5558f336.album_placeholder-blank.png",progress:a.progress});for(var d=c.querySelectorAll(".button-response"),e=0;e<d.length;e++)d[e].addEventListener("click",function(a){a.preventDefault(),manager.check(+this.getAttribute("data-index"))},!1);c.classList.remove("fadeout")},500)}};var SpotifyPlaylistsImporter=function(){function a(a){"http://jmperezperez.com"===a.origin&&a.data.accessToken&&(b.authWindow&&b.authWindow.close(),null!==b.callback&&(b.callback(a.data.accessToken),b.callback=null))}this.callback=null,this.authWindow=null;var b=this;window.addEventListener("message",a,!1)};SpotifyPlaylistsImporter.prototype.login=function(a){function b(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")}this.callback=a;var c=400,d=500,e=screen.width/2-c/2,f=screen.height/2-d/2,g={client_id:"8d17e83b5fd84c38a7e41fdc57291de3",redirect_uri:"jmperezperez.com/hacks/iquiz/callback.html",scope:"user-read-private playlist-read playlist-read-private",response_type:"token"};this.authWindow=window.open("https://accounts.spotify.com/authorize?"+b(g),"Spotify","menubar=no,location=no,resizable=no,scrollbars=no,status=no, width="+c+", height="+d+", top="+f+", left="+e)},SpotifyPlaylistsImporter.prototype._signedRequest=function(a,b){var c=when.defer(),d=new XMLHttpRequest;d.open("GET",a,!0);return d.setRequestHeader("Authorization","Bearer "+b),d.onload=function(){if(200==d.status){var a=JSON.parse(d.responseText);c.resolve(a)}else c.resolve(null)},d.send(null),c.promise},SpotifyPlaylistsImporter.prototype.importPlaylists=function(a,b){console.log("importPlaylists",a);var c=this;this._signedRequest("https://api.spotify.com/v1/me",a).then(function(d){var e=d.id;c._signedRequest("https://api.spotify.com/v1/users/"+e+"/playlists",a).then(function(d){console.log("Playlists dude",d);var e=[];d.forEach(function(b){e.push(c._signedRequest(b.api_link,a))});var f=when.all(e);f.then(function(a){console.log("All playlists where imported"),b(a)},function(){console.log("Some of them failed",results),b(results)})})})},function(){"use strict";console.log("Do something")}();var manager,renderer,textToVoice,reader,player,generator,q;document.getElementById("login").addEventListener("click",function(){login()});
